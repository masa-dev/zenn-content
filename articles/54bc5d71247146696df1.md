---
title: "GCPã®CloudRunã§Vueã‚¢ãƒ—ãƒªã‚’å…¬é–‹ã™ã‚‹ã¾ã§"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [gcp, vue, nginx]
published: true
---

- 2022/5/16 è¿½è¨˜

## ç’°å¢ƒ

- windows 11ï¼ˆã»ã¼é–¢ä¿‚ç„¡ã„ï¼‰
- docker
- google cloud sdk (pythonå¿…é ˆ)

## Vue ã‚µã‚¤ãƒˆã®ä½œæˆ

å–ã‚Šæ•¢ãˆãšé©å½“ãªæœ€å°æ§‹æˆã§ä½œæˆã—ã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä½¿ç”¨ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ«ãƒ¼ãƒˆã«ä¿å­˜ã—ã¾ã™ã€‚

```dockerfile:Dockerfile
FROM node:16.15.0-buster-slim

WORKDIR /app

RUN apt-get update && \
    npm install -g npm @vue/cli
```

```yml:docker-compose.yml
version: "3.7"

services:
  web:
    container_name: "vue-test"
    build:
      context: "./"
      dockerfile: "Dockerfile"
    working_dir: /app
    volumes:
      - ./app/:/app/
    ports:
      - 50080:80
```

Vue CLI ã®ã‚³ãƒãƒ³ãƒ‰ã§ç’°å¢ƒã‚’ã‚µã‚¯ãƒƒã¨ç”Ÿæˆã—ã¾ã™ã€‚  
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¯ä»»æ„ã§å¤§ä¸ˆå¤«ã§ã™ãŒã€å¾Œã§`src`ãƒ•ã‚©ãƒ«ãƒ€ã«å¤‰æ›´ã—ã¾ã™ã€‚

```bash
vue create cloudrun-sample
```

åå‰ã®å¤‰æ›´

```bash
rm -rf app
mv cloudrun-sample app
```

vue ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå®Ÿè¡Œã§ãã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

```bash
cd app
npm run serve
```

![vueã®dockerèµ·å‹•ç”»é¢](/images/vue-docker-1.png)

ç¢ºèªå‡ºæ¥ãŸã‚‰ã€ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚ã“ã®ãƒ“ãƒ«ãƒ‰ã®å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚  
ç”Ÿæˆç‰©ã¯`dist`ãƒ•ã‚©ãƒ«ãƒ€ã«æ ¼ç´ã•ã‚Œã¾ã™ã€‚

```bash
npm run build
```

## cloud run ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æº–å‚™

ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã® Dockerfile ã‚’ç”¨æ„ã—ã¾ã™ã€‚  
ä»Šå›ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãªã—ã§æ§‹ç¯‰ã™ã‚‹ã®ã§ã€nginx ã®ã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

```dockerfile:CloudRun.Dockerfile
FROM nginx:alpine

# å‡ºåŠ›ãƒ•ã‚©ãƒ«ãƒ€ã‚’è¡¨ç¤ºã•ã›ã‚‹
ADD ./app/dist/ /usr/share/nginx/html/
ADD ./nginx/ /etc/nginx/conf.d/

EXPOSE 8080
CMD ["nginx", "-g", "daemon off;"]
```

ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®`CloudRun.Dockerfile`ã‚’èª­ã¿è¾¼ã‚ã‚‹ã‚ˆã†ã«
`cloudbuild.yml`ã§ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¨ã‚¤ãƒ¡ãƒ¼ã‚¸åã‚’æŒ‡å®šã—ã¾ã™ã€‚

| å¤‰æ•°         | èª¬æ˜                                                |
| ------------ | --------------------------------------------------- |
| `PROJECT_ID` | GCP ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ID<br>GCPã®ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‹ã‚‰å–å¾—ã§ãã‚‹ |
| `IMAGE`      | ãƒ“ãƒ«ãƒ‰ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä¿å­˜åï¼ˆä»»æ„ã®åå‰ï¼‰    |

```yml:cloudbuild.yml
step:
  # Build the container image
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'gcr.io/{ PROJECT_ID }/{ IMAGE }', '-f', 'CloudRun.Dockerfile' '.']
images:
- 'gcr.io/{ PROJECT_ID }/{ IMAGE }'
```

`nginx`ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã€ãã®ä¸­ã«`default.conf`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚  
ã“ã“ã§ã€ãƒãƒ¼ãƒˆã‚’`80`ã‹ã‚‰`8080`ã«å¤‰æ›´ã—ãªã„ã¨ã€ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

:::message
__ãƒãƒ¼ãƒˆãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„ã¨ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚__

>Deployment failed\
>ERROR: (gcloud.run.deploy) Cloud Run error: The user-provided container failed to start and listen on the port defined provided by the PORT=8080 environment variable. Logs for this revision might contain more information.
:::

```diff nginx:nginx/default.conf
server {
+ listen       8080;
  server_name  localhost;

  location / {
    root   /usr/share/nginx/html;
    index  index.html index.htm;
  }

  error_page 500 502 503 504  /50x.html;
  location = /50x.html {
    root     /usr/share/nginx/html;
  }
}
```


## ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤

- `gcloud init`ãªã©ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãŠã
- ä»¥ä¸‹ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã€‚
  - Container Registry
  - Cloud Build
  - (Cloud Strage)

`cloudbuild.yml`ã‚’å‚ç…§ã—ã¦ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚
```bash
gcloud builds submit ./ --config cloudbuild.yml
```

ãƒ“ãƒ«ãƒ‰ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å…ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
```bash
gcloud run deploy vue-test --image gcr.io/{ PROJECT_ID }/{ IMAGE }
```

æˆåŠŸã™ã‚‹ã¨ã€Cloud Runã®ãƒšãƒ¼ã‚¸ã§ç¢ºèªã§ãã¾ã™ã€‚

![](/images/vue-cloudrun-1.png)

## ã‚¨ãƒ©ãƒ¼

~~ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€`rm -rf ./node_modules/`ãªã©ã§`node_modules`ã‚’å‰Šé™¤ã™ã‚‹ã¨è§£æ±ºã™ã‚‹ã€‚ãªãœèµ·ã“ã£ãŸã‹ä¸æ˜ã€‚~~

`.gcloudignore`ã«`*/node_modules`ã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§è§£æ±ºã—ã¾ã—ãŸã€‚

```log
gcloud crashed (OSError): [WinError 1920] ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚ ./app\node_modules\\.bin\\acorn'
```

```ignore:.gcloudignore
*/node_modules
```

8080ãƒãƒ¼ãƒˆãŒèª­ã¿è¾¼ã‚ãªã„
```log
ERROR: (gcloud.run.deploy) Cloud Run error: The user-provided container failed to start and listen on the port defined provided by the PORT=8080 environment variable. 
Logs for this revision might contain more information.
```

## çµ‚ã‚ã‚Š

vueã®ã‚µãƒ¼ãƒãƒ¼èµ·å‹•æ™‚ã¨ãƒ“ãƒ«ãƒ‰ã—ãŸç”Ÿæˆç‰©ã®è¡¨ç¤ºãŒé•ã†å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€docker-composeã®æ–¹ã§nginxã®ç’°å¢ƒã‚’ä½œã£ãŸæ–¹ãŒè‰¯ã‹ã£ãŸã‹ã‚‚ã—ã‚Œãªã„ã€‚
